<!DOCTYPE html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <title>Waragraph Web</title>
  </head>
  <body>
    <canvas id="main_view" width=800 height=600></canvas>

    <canvas id="path_view" width=800 height=200></canvas>

    <script src='./module-workers-polyfill.min.js'></script>
    <!-- <script src='./pkg/web.js'></script> -->

    <script type="module">

      console.log("what");

      import * as Comlink from "https://unpkg.com/comlink/dist/esm/comlink.mjs";

      import init_module, * as wasm_bindgen from './pkg/web.js';

      console.log("okay");

      async function init() {
          const worker = new Worker("main_worker.js", { type: 'module' });

          worker.onmessage = (event) => {
              worker.onmessage = undefined;

              console.log("graph loaded");
              const obj = Comlink.wrap(worker);

              let canvas = document.getElementById('path_view');
              let offscreen = canvas.transferControlToOffscreen();
              obj.connectCanvas(Comlink.transfer(offscreen, [offscreen]));
              obj.sampleRange(0, 10000);

              // obj.sample_data(0, 10000, 512)
              //     .then((data) => {
              //         console.log("sampled data");
              //         console.log(data);
              //     });


              window.worker_obj = obj;
              
          };


      }

      init();

      
    </script>


<!-- 
    <script type="module">
      import init_module, * as waragraph from './pkg/web.js';
      let wasm;

      async function run() {
          wasm = await init_module();
          console.log(waragraph);
          console.log(wasm);
          window.wasm = wasm;
          window.waragraph = waragraph;
          
          const gfa_path = '../data/A-3105.fa.353ea42.34ee7b1.1576367.smooth.fix.gfa';
          const tsv_path = '../data/A-3105.layout.tsv';

          // const gfa_path = '../cerevisiae.pan.fa.gz.d1a145e.417fcdf.7493449.smooth.final.gfa';
          // const tsv_path = '../cerevisiae.pan.fa.gz.d1a145e.417fcdf.7493449.smooth.final.og.lay.tsv';

          let gfa = fetch(gfa_path);
          let tsv = fetch(tsv_path);
          console.log(gfa);

          const canvas = document.getElementById("main_view");

          console.log("init");
          let ctx = await waragraph.initialize_with_data_fetch(gfa, tsv, canvas);
          window.ctx = ctx;

          // const path_view = ctx.init_path_viewer("gi|568815592:29942469-29945883");
          // let path_canvas = document.getElementById("path_view");
          // path_view.draw_to_canvas(0, 20000, path_canvas);
          // window.path_viewer = path_view;

          // ctx.run()

      }

      run();
    </script>
    -->
  </body>
</html>

