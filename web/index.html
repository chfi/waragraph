<!DOCTYPE html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <title>Waragraph Web</title>
  </head>
  <body>
    <canvas id="main_view" width=800 height=600></canvas>

    <canvas id="overview_map" width=1024 height=40></canvas>
    <canvas id="path_view" width=1024 height=200></canvas>

    <script src='./module-workers-polyfill.min.js'></script>

    <script src='./rxjs.umd.min.js'></script>

    <script type="module">

      console.log("what");

      // import * as Comlink from "https://unpkg.com/comlink/dist/esm/comlink.mjs";
      import * as Comlink from './comlink.mjs';

      const { Observable } = rxjs;

      import { initializePathViewer, addOverviewEventHandlers, addPathViewerLogic } from './path_viewer_ui.js';

      import init_module, * as wasm_bindgen from './pkg/web.js';

      import { OverviewMap } from './overview.js';

      console.log("okay");

      async function init() {

          const handler = await import('./transfer_handlers.js');
          handler.setTransferHandlers(rxjs, Comlink);


          const worker = new Worker("main_worker.js", { type: 'module' });

          worker.onmessage = async (event) => {
              worker.onmessage = undefined;

              console.log("graph loaded");
              const obj = Comlink.wrap(worker);

              let canvas = document.getElementById('path_view');
              let path_name = "gi|528476637:29857558-29915771";

              let cs_view = await obj.globalCoordSys();
              let view_max = await cs_view.viewMax();

              let overview = new OverviewMap(document.getElementById('overview_map'),  view_max);
              await addOverviewEventHandlers(overview, cs_view);

    // const path_viewer = await obj.createPathViewer(Comlink.transfer(offscreen, [offscreen]),
                                                      // path_name);

              let path_viewer = await initializePathViewer(obj, overview, cs_view, path_name, canvas);

      // let path_viewer = await obj.createPathViewer(Comlink.transfer(offscreen, [offscreen]),
                                                      // path_name);


              // path_viewer.connectCanvas(Comlink.transfer(offscreen, [offscreen]));
      /*
              obj.createPathViewer(Comlink.transfer(offscreen, [offscreen]),
                                   path_name)
              .then(async (path_viewer) => {


                  path_viewer.setView(0, 1000);
                  // path_viewer.sample();
                  // window.path_viewer = path_viewer;

                  let cs_view = await obj.globalCoordSys();
                  let coord_sys = await cs_view.coord_sys;

                  let max = await cs_view.viewMax();

                  // obj.globalCoordSys().then((cs_view) => {
                      console.log(coord_sys);
                  let overview = new OverviewMap(document.getElementById('overview_map'), max);

                      // addPathViewerEventHandlers(obj, path_viewer, canvas, overview);
                      addPathViewerLogic(obj, path_viewer, canvas, overview, cs_view);
                  // });
                  console.log("????????????");


                  window.path_viewer = path_viewer;

              });
        */

              window.worker_obj = obj;
              
          };


      }

      init();

      
    </script>

  </body>
</html>

